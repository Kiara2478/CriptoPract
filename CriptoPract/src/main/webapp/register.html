<!doctype html>
<html lang="en">
    <!--begin::Head-->
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <title>AdminLTE 4 | Register Page</title>
        <!--begin::Primary Meta Tags-->
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="title" content="AdminLTE 4 | Register Page" />
        <meta name="author" content="ColorlibHQ" />
        <meta
            name="description"
            content="AdminLTE is a Free Bootstrap 5 Admin Dashboard, 30 example pages using Vanilla JS."
            />
        <meta
            name="keywords"
            content="bootstrap 5, bootstrap, bootstrap 5 admin dashboard, bootstrap 5 dashboard, bootstrap 5 charts, bootstrap 5 calendar, bootstrap 5 datepicker, bootstrap 5 tables, bootstrap 5 datatable, vanilla js datatable, colorlibhq, colorlibhq dashboard, colorlibhq admin dashboard"
            />
        <!--end::Primary Meta Tags-->
        <!--begin::Fonts-->
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css"
            integrity="sha256-tXJfXfp6Ewt1ilPzLDtQnJV4hclT9XuaZUKyUvmyr+Q="
            crossorigin="anonymous"
            />
        <!--end::Fonts-->
        <!--begin::Third Party Plugin(OverlayScrollbars)-->
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.10.1/styles/overlayscrollbars.min.css"
            integrity="sha256-tZHrRjVqNSRyWg2wbppGnT833E/Ys0DHWGwT04GiqQg="
            crossorigin="anonymous"
            />
        <!--end::Third Party Plugin(OverlayScrollbars)-->
        <!--begin::Third Party Plugin(Bootstrap Icons)-->
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
            integrity="sha256-9kPW/n5nn53j4WMRYAxe9c1rCY96Oogo/MKSVdKzPmI="
            crossorigin="anonymous"
            />
        <!--end::Third Party Plugin(Bootstrap Icons)-->
        <!--begin::Required Plugin(AdminLTE)-->
        <link href="css/adminlte.css" rel="stylesheet" type="text/css"/>
        <!--end::Required Plugin(AdminLTE)-->

        <style>
            .alert {
                margin-top: 10px;
            }
            .registro-completo {
                display: none;
            }
            .form-switch {
                margin: 20px 0;
            }
        </style>
    </head>
    <!--end::Head-->
    <!--begin::Body-->
    <body class="register-page bg-body-secondary">
        <div class="register-box" style="width: 400px;">
            <div class="register-logo">
                <a href="persona.html"><b>Admin</b>LTE</a>
            </div>
            <!-- /.register-logo -->
            <div class="card">
                <div class="card-body register-card-body">
                    <p class="register-box-msg">Registrar nuevo usuario</p>

                    <!-- Alerta para mostrar mensajes -->
                    <div id="alertMessage" class="alert" style="display: none;" role="alert"></div>

                    <!-- Switch para alternar entre registro básico y completo -->
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="registroCompletoSwitch">
                        <label class="form-check-label" for="registroCompletoSwitch">
                            Registro completo (con datos adicionales)
                        </label>
                    </div>

                    <form id="registroForm">
                        <!-- Campos básicos -->
                        <div class="input-group mb-3">
                            <input type="text" id="nombre" class="form-control" placeholder="Nombre completo" required />
                            <div class="input-group-text"><span class="bi bi-person"></span></div>
                        </div>

                        <div class="input-group mb-3">
                            <input type="text" id="login" class="form-control" placeholder="Nombre de usuario" required />
                            <div class="input-group-text"><span class="bi bi-person-badge"></span></div>
                        </div>

                        <div class="input-group mb-3">
                            <input type="password" id="password" class="form-control" placeholder="Contraseña" required />
                            <div class="input-group-text"><span class="bi bi-lock-fill"></span></div>
                        </div>

                        <div class="input-group mb-3">
                            <input type="password" id="confirmPassword" class="form-control" placeholder="Confirmar contraseña" required />
                            <div class="input-group-text"><span class="bi bi-lock"></span></div>
                        </div>

                        <!-- Campos adicionales para registro completo -->
                        <div id="camposCompletos" class="registro-completo">
                            <div class="input-group mb-3">
                                <input type="text" id="dni" class="form-control" placeholder="DNI" />
                                <div class="input-group-text"><span class="bi bi-card-text"></span></div>
                            </div>

                            <div class="input-group mb-3">
                                <input type="date" id="fechaNacimiento" class="form-control" />
                                <div class="input-group-text"><span class="bi bi-calendar"></span></div>
                            </div>

                            <div class="input-group mb-3">
                                <input type="number" id="peso" class="form-control" placeholder="Peso (kg)" step="0.1" min="1" />
                                <div class="input-group-text"><span class="bi bi-speedometer2"></span></div>
                            </div>
                        </div>

                        <!--begin::Row-->
                        <div class="row">

                            <!-- /.col -->
                            <div class="col-12">
                                <div class="d-grid gap-2">
                                    <button type="submit" id="btnRegistro" class="btn btn-primary">
                                        <span id="btnTexto">Registrar</span>
                                        <span id="btnSpinner" class="spinner-border spinner-border-sm ms-2" style="display: none;"></span>
                                    </button>
                                </div>
                            </div>
                            <!-- /.col -->
                        </div>
                        <!--end::Row-->
                    </form>
                    <!-- /.social-auth-links -->

                    <p class="mb-0 text-center">
                        <br>
                        <a href="index.html" class="text-center">Ya tengo una cuenta</a>
                    </p>
                </div>
                <!-- /.register-card-body -->
            </div>
        </div>
        <!-- /.register-box -->

        <!--begin::Third Party Plugin(OverlayScrollbars)-->
        <script
            src="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.10.1/browser/overlayscrollbars.browser.es6.min.js"
            integrity="sha256-dghWARbRe2eLlIJ56wNB+b760ywulqK3DzZYEpsg2fQ="
            crossorigin="anonymous"
        ></script>
        <!--end::Third Party Plugin(OverlayScrollbars)--><!--begin::Required Plugin(popperjs for Bootstrap 5)-->
        <script
            src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js"
            integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r"
            crossorigin="anonymous"
        ></script>
        <!--end::Required Plugin(popperjs for Bootstrap 5)--><!--begin::Required Plugin(Bootstrap 5)-->
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"
            integrity="sha384-0pUGZvbkm6XF6gxjEnlmuGrJXVbNuzT9qBBavbLwCsOGabYfZo0T0to5eqruptLy"
            crossorigin="anonymous"
        ></script>
        <!--end::Required Plugin(Bootstrap 5)--><!--begin::Required Plugin(AdminLTE)-->
        <script src="js/adminlte.js" type="text/javascript"></script>
        <!--end::Required Plugin(AdminLTE)-->

        <script>
            // Configuración de la aplicación
            const API_BASE_URL = window.location.origin + '/CriptoIIP'; // Ajusta según tu contexto

            // Referencias a elementos del DOM
            const registroForm = document.getElementById('registroForm');
            const registroCompletoSwitch = document.getElementById('registroCompletoSwitch');
            const camposCompletos = document.getElementById('camposCompletos');
            const alertMessage = document.getElementById('alertMessage');
            const btnRegistro = document.getElementById('btnRegistro');
            const btnTexto = document.getElementById('btnTexto');
            const btnSpinner = document.getElementById('btnSpinner');

            // Alternar campos adicionales
            registroCompletoSwitch.addEventListener('change', function () {
                if (this.checked) {
                    camposCompletos.style.display = 'block';
                    camposCompletos.classList.remove('registro-completo');
                    // Hacer campos obligatorios
                    document.getElementById('dni').required = true;
                    document.getElementById('fechaNacimiento').required = true;
                    document.getElementById('peso').required = true;
                } else {
                    camposCompletos.style.display = 'none';
                    camposCompletos.classList.add('registro-completo');
                    // Quitar obligatoriedad
                    document.getElementById('dni').required = false;
                    document.getElementById('fechaNacimiento').required = false;
                    document.getElementById('peso').required = false;
                }
            });

            // Manejar el envío del formulario
            registroForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                // Validar contraseñas
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                if (password !== confirmPassword) {
                    mostrarAlerta('Las contraseñas no coinciden', 'danger');
                    return;
                }

                if (password.length < 3) {
                    mostrarAlerta('La contraseña debe tener al menos 3 caracteres', 'danger');
                    return;
                }

                // Deshabilitar botón y mostrar spinner
                btnRegistro.disabled = true;
                btnSpinner.style.display = 'inline-block';
                btnTexto.textContent = 'Registrando...';

                try {
                    const esRegistroCompleto = registroCompletoSwitch.checked;
                    const datos = recopilarDatos(esRegistroCompleto);

                    const response = await enviarRegistro(datos, esRegistroCompleto);

                    if (response.status === 'success') {
                        mostrarAlerta('¡Usuario registrado exitosamente!', 'success');
                        registroForm.reset();

                        // Opcional: redireccionar después de 2 segundos
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 2000);
                    } else {
                        mostrarAlerta(response.message || 'Error al registrar usuario', 'danger');
                    }

                } catch (error) {
                    console.error('Error:', error);
                    mostrarAlerta('Error de conexión. Intente nuevamente.', 'danger');
                } finally {
                    // Rehabilitar botón
                    btnRegistro.disabled = false;
                    btnSpinner.style.display = 'none';
                    btnTexto.textContent = 'Registrar';
                }
            });

            // Recopilar datos del formulario
            function recopilarDatos(esCompleto) {
                const datos = {
                    nombre: document.getElementById('nombre').value.trim(),
                    login: document.getElementById('login').value.trim(),
                    password: document.getElementById('password').value
                };

                if (esCompleto) {
                    datos.dni = document.getElementById('dni').value.trim();
                    datos.fechaNacimiento = document.getElementById('fechaNacimiento').value;
                    datos.peso = parseFloat(document.getElementById('peso').value);
                }

                return datos;
            }

            // Enviar datos al servlet
            async function enviarRegistro(datos, esCompleto) {
                const metodo = esCompleto ? 'PUT' : 'POST';
                const url = `${API_BASE_URL}/registro`;

                const response = await fetch(url, {
                    method: metodo,
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(datos)
                });

                return await response.json();
            }

            // Mostrar alerta
            function mostrarAlerta(mensaje, tipo) {
                alertMessage.className = `alert alert-${tipo}`;
                alertMessage.textContent = mensaje;
                alertMessage.style.display = 'block';

                // Auto-ocultar después de 5 segundos para alertas de éxito
                if (tipo === 'success') {
                    setTimeout(() => {
                        alertMessage.style.display = 'none';
                    }, 5000);
                }
            }

            // Configurar OverlayScrollbars
            const SELECTOR_SIDEBAR_WRAPPER = '.sidebar-wrapper';
            const Default = {
                scrollbarTheme: 'os-theme-light',
                scrollbarAutoHide: 'leave',
                scrollbarClickScroll: true,
            };

            document.addEventListener('DOMContentLoaded', function () {
                const sidebarWrapper = document.querySelector(SELECTOR_SIDEBAR_WRAPPER);
                if (sidebarWrapper && typeof OverlayScrollbarsGlobal?.OverlayScrollbars !== 'undefined') {
                    OverlayScrollbarsGlobal.OverlayScrollbars(sidebarWrapper, {
                        scrollbars: {
                            theme: Default.scrollbarTheme,
                            autoHide: Default.scrollbarAutoHide,
                            clickScroll: Default.scrollbarClickScroll,
                        },
                    });
                }
            });
        </script>
    </body>
</html>
