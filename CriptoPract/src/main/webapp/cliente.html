<!doctype html>
<html lang="es">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>AdminLTE v4 | Dashboard</title>

        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="title" content="AdminLTE v4 | Dashboard" />
        <meta name="author" content="ColorlibHQ" />
        <meta
            name="description"
            content="AdminLTE is a Free Bootstrap 5 Admin Dashboard, 30 example pages using Vanilla JS."
            />
        <meta
            name="keywords"
            content="bootstrap 5, bootstrap, bootstrap 5 admin dashboard, bootstrap 5 dashboard, bootstrap 5 charts, bootstrap 5 calendar, bootstrap 5 datepicker, bootstrap 5 tables, bootstrap 5 datatable, vanilla js datatable, colorlibhq, colorlibhq dashboard, colorlibhq admin dashboard"
            />

        <!-- Hojas de estilo -->
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css"
            integrity="sha256-tXJfXfp6Ewt1ilPzLDtQnJV4hclT9XuaZUKyUvmyr+Q="
            crossorigin="anonymous"
            />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.10.1/styles/overlayscrollbars.min.css"
            integrity="sha256-tZHrRjVqNSRyWg2wbppGnT833E/Ys0DHWGwT04GiqQg="
            crossorigin="anonymous"
            />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
            integrity="sha256-9kPW/n5nn53j4WMRYAxe9c1rCY96Oogo/MKSVdKzPmI="
            crossorigin="anonymous"
            />

        <!-- CSS DE ADMIN LTE -->
        <link href="css/adminlte.css" rel="stylesheet" type="text/css"/>

        <!-- Scripts externos GOOGLE - MD5-->
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.css"
            integrity="sha256-4MX+61mt9NVvvuPjUWdUdyfZfxSB1/Rf9WtqRHgG5S0="
            crossorigin="anonymous"
            />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/jsvectormap@1.5.3/dist/css/jsvectormap.min.css"
            integrity="sha256-+uGLJmmTKOqBr+2E6KDYs/NRsHxSkONXFHUL0fy2O/4="
            crossorigin="anonymous"
            />
        <!-- jQuery -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    </head>

    <body>
        <div class="app-wrapper">
            <!-- CABECERA PRINCIPAL -->
            <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
                <div class="container-fluid">
                    <a class="navbar-brand" href="#">
                        <i class="bi bi-people-fill me-2"></i>Gestión de Clientes
                    </a>

                    <!-- INFORMACIÓN DE USUARIO -->
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
                                <i class="bi bi-person-circle me-1"></i>
                                <span id="userName">Usuario</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li class="dropdown-header">
                                    <strong id="nombRol">Rol</strong><br>
                                    <small class="text-muted" id="nombEmpr">Empresa</small>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#cambiarClaveModal">
                                        <i class="bi bi-key me-2"></i>Cambiar Contraseña
                                    </a></li>
                                <li><a class="dropdown-item" href="#" id="logoutBtn">
                                        <i class="bi bi-box-arrow-right me-2"></i>Cerrar Sesión
                                    </a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- BARRA LATERAL -->
            <aside class="app-sidebar bg-body-secondary shadow" data-bs-theme="dark">
                <div class="sidebar-brand">    
                    <!--LOGO LATERAL-->
                    <a href="principal.html" class="brand-link">
                        <img
                            src="assets/img/AdminLTELogo.png"
                            alt="AdminLTE Logo"
                            class="brand-image opacity-75 shadow"
                            />

                        <span class="brand-text fw-light">AdminLTE 4</span>
                    </a>
                </div>

                <div class="sidebar-wrapper">
                    <nav class="mt-2">
                        <!-- DASHBOARD-->
                        <ul
                            class="nav sidebar-menu flex-column"
                            data-lte-toggle="treeview"
                            role="menu"
                            data-accordion="false"
                            >
                            <li class="nav-item menu-open">
                                <a href="#" class="nav-link active">
                                    <i class="nav-icon bi bi-speedometer"></i>
                                    <p>
                                        Dashboard
                                        <i class="nav-arrow bi bi-chevron-right"></i>
                                    </p>
                                </a>
                                <ul class="nav nav-treeview">
                                    <li class="nav-item">
                                        <a href="persona.html" class="nav-link">
                                            <i class="nav-icon bi bi-circle"></i>
                                            <p>Listar personas</p>
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a href="persona.html" class="nav-link">
                                            <i class="nav-icon bi bi-circle"></i>
                                            <p>Crud personas</p>
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a href="cliente.html" class="nav-link active">
                                            <i class="nav-icon bi bi-circle"></i>
                                            <p>Crud clientes</p>
                                        </a>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </nav>
                </div>
            </aside>

            <!-- CONTENIDO PRINCIPAL -->
            <main class="container-fluid p-4">
                <div class="card shadow">
                    <!-- CABECERA DE LA TARJETA -->
                    <div class="card-header d-flex justify-content-between align-items-center text-black">
                        <h3 class="mb-0"><i class="bi bi-people me-2"></i>Gestión de Clientes</h3>
                        <div>
                            <button class="btn btn-primary btn-sm me-2" onclick="openNewClienteModal()">
                                <i class="bi bi-plus-circle"></i> Nuevo Cliente
                            </button>
                            <button class="btn btn-success text-light btn-sm" onclick="loadClientes()">
                                <i class="bi bi-arrow-clockwise"></i> Actualizar
                            </button>
                            <span class="badge bg-warning text-dark ms-2" id="totalClientes">0</span>
                        </div>
                    </div>

                    <div class="card-body">
                        <!-- ALERTAS -->
                        <div id="alertContainer"></div>

                        <!-- ESTADO DE CARGA -->
                        <div id="loadingState" class="text-center p-4" style="display: none;">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                            <p class="mt-2">Cargando clientes...</p>
                        </div>

                        <!-- BUSCADOR -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="searchInput" 
                                           placeholder="Buscar por nombre, DNI..." 
                                           onkeyup="filterClientes()">
                                </div>
                            </div>
                        </div>

                        <!-- Boton de reporte-->
                                        <div class="mb-2">
                                            <a href="/CriptoPract/clientePDF" target="_blank" class="btn btn-success">
                                                📄 Generar Reporte
                                            </a>
                                        </div>
                        
                        <!-- TABLA DE CLIENTES -->
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark text-center">
                                    <tr>
                                        <th>ID</th>
                                        <th>DNI</th>
                                        <th>Nombres</th>
                                        <th>Celular</th>
                                        <th>Dirección</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="clientesTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Cargando...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>

            <!--PIE DE PAGINA -->
            <footer class="app-footer">
                <!--MENSAJE DERECHA-->
                <div class="float-end d-none d-sm-inline">Anything you want</div>

                <strong>
                    Copyright &copy; 2022-2025&nbsp;
                    <a href="https://adminlte.io" class="text-decoration-none">AdminLTE.io</a>.
                </strong>
                All rights reserved.
            </footer>
        </div>

        <!-- MODAL PARA CAMBIAR CONTRASEÑA -->
        <div class="modal fade" id="cambiarClaveModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-warning">
                        <h5 class="modal-title">Cambiar Contraseña</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="formCambiarClave">
                            <div class="mb-3">
                                <label for="logiUsua" class="form-label">Usuario *</label>
                                <input type="text" class="form-control" id="logiUsua" required readonly>
                            </div>
                            <div class="mb-3">
                                <label for="passUsua" class="form-label">Contraseña Actual *</label>
                                <input type="password" class="form-control" id="passUsua" required>
                            </div>
                            <div class="mb-3">
                                <label for="newpass" class="form-label">Nueva Contraseña *</label>
                                <input type="password" class="form-control" id="newpass" required minlength="4">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" form="formCambiarClave" class="btn btn-warning">
                            <i class="bi bi-key"></i> Cambiar Contraseña
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL PARA CREAR/EDITAR CLIENTE -->
        <div class="modal fade" id="clienteModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="clienteModalTitle">Nuevo Cliente</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="formCliente">
                            <input type="hidden" id="clienteId" name="codiClie">
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="ndniClie" class="form-label">DNI *</label>
                                        <input type="text" class="form-control" id="ndniClie" name="ndniClie" 
                                               required maxlength="8" pattern="[0-9]{8}">
                                        <div class="form-text">Ingrese 8 dígitos</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="celuClie" class="form-label">Celular</label>
                                        <input type="text" class="form-control" id="celuClie" name="celuClie" 
                                               maxlength="9" pattern="[0-9]{9}">
                                        <div class="form-text">Ingrese 9 dígitos (opcional)</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="nombClie" class="form-label">Nombres Completos *</label>
                                <input type="text" class="form-control" id="nombClie" name="nombClie" 
                                       required maxlength="100">
                            </div>
                            
                            <div class="mb-3">
                                <label for="direClie" class="form-label">Dirección</label>
                                <textarea class="form-control" id="direClie" name="direClie" 
                                          rows="3" maxlength="200"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" form="formCliente" class="btn btn-primary" id="btnSaveCliente">
                            <i class="bi bi-save"></i> Guardar Cliente
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL DE CONFIRMACIÓN PARA ELIMINAR -->
        <div class="modal fade" id="deleteModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">Confirmar Eliminación</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p class="mb-3"><i class="bi bi-exclamation-triangle text-warning fs-1"></i></p>
                        <p><strong>¿Está seguro que desea eliminar este cliente?</strong></p>
                        <p class="text-muted">Esta acción no se puede deshacer.</p>
                        <div class="alert alert-info">
                            <strong>Cliente a eliminar:</strong><br>
                            <span id="deleteClienteInfo"></span>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                            <i class="bi bi-trash"></i> Eliminar Cliente
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

        <!-- SCRIPTS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

        <script>
            // Variables globales
            let clientes = [];
            let clientesOriginal = [];
            let currentUserLogin = '';
            let currentClienteId = null;

            // Inicialización al cargar la página
            $(document).ready(function () {
                console.log("=== INICIANDO APLICACIÓN ===");
                verificarSesion();
                loadClientes();
                configurarEventos();
            });

            // Verificar sesión activa
            function verificarSesion() {
                console.log("Verificando sesión...");
                $.ajax({
                    url: "sessioninfoservlet",
                    type: "GET",
                    dataType: "json",
                    timeout: 10000,
                    success: function (data) {
                        console.log("Datos de sesión:", data);
                        if (data.error || !data.usuarioId) {
                            console.log("No hay sesión activa, redirigiendo...");
                            window.location.href = "index.html";
                        } else {
                            $("#userName").text(data.usuarioNombre || data.nombUsua || "Usuario");
                            currentUserLogin = data.usuarioLogin;

                            if (data.nombRol) $("#nombRol").text(data.nombRol);
                            if (data.nombEmpr) $("#nombEmpr").text(data.nombEmpr);

                            console.log("Sesión válida para usuario:", data.usuarioNombre);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.log("Error en verificación de sesión:", error);
                        if (xhr.status === 401 || xhr.status === 403 || status === 'timeout') {
                            window.location.href = "index.html";
                        }
                    }
                });
            }

            // Configurar eventos
            function configurarEventos() {
                // Logout
                $("#logoutBtn").click(function (e) {
                    e.preventDefault();
                    if (confirm("¿Está seguro que desea cerrar sesión?")) {
                        $.ajax({
                            url: "logout",
                            type: "POST",
                            dataType: "json",
                            success: function (response) {
                                window.location.href = "index.html";
                            },
                            error: function (xhr, status, error) {
                                window.location.href = "index.html";
                            }
                        });
                    }
                });

                // Pre-llenar usuario al abrir modal de cambiar contraseña
                $('#cambiarClaveModal').on('show.bs.modal', function () {
                    $('#logiUsua').val(currentUserLogin);
                });

                // Cambiar contraseña
                $("#formCambiarClave").submit(function (e) {
                    e.preventDefault();
                    let logiUsua = $("#logiUsua").val();
                    let passUsua = $("#passUsua").val();
                    let newpass = $("#newpass").val();

                    if (!logiUsua || !passUsua || !newpass) {
                        showAlert("Todos los campos son obligatorios", 'danger');
                        return;
                    }

                    //const passUsuaHash = CryptoJS.MD5(passUsua).toString();
                    //const newpassHash = CryptoJS.MD5(newpass).toString();

                    $.ajax({
                        url: "cambiarcontrasena",
                        type: "POST",
                        data:{
                            logiUsua: logiUsua,
                            passUsua: passUsua,
                            newpass: newpass
                        },
                        dataType: "json",
                        success: function (response) {
                            if (response.resultado === "ok") {
                                showAlert(response.mensaje, 'success');
                                $("#cambiarClaveModal").modal('hide');
                                $("#formCambiarClave")[0].reset();
                                setTimeout(() => window.location.href = "index.html", 2000);
                            } else {
                                showAlert(response.mensaje, 'danger');
                            }
                        },
                        error: function () {
                            showAlert("Error al procesar la solicitud", 'danger');
                        }
                    });
                });

                // Formulario de cliente
                $("#formCliente").submit(function (e) {
                    e.preventDefault();
                    saveCliente();
                });

                // Botón de confirmación de eliminación
                $("#confirmDeleteBtn").click(function () {
                    if (currentClienteId) {
                        deleteClienteConfirmed(currentClienteId);
                    }
                });

                // Validación en tiempo real del DNI
                $("#ndniClie").on('input', function() {
                    this.value = this.value.replace(/[^0-9]/g, '').substring(0, 8);
                });

                // Validación en tiempo real del celular
                $("#celuClie").on('input', function() {
                    this.value = this.value.replace(/[^0-9]/g, '').substring(0, 9);
                });
            }

            // Mostrar alertas
            function showAlert(message, type = 'info') {
                const alertHTML = `
                    <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                        <i class="bi bi-${getIconForAlert(type)} me-2"></i>${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>`;
                $("#alertContainer").html(alertHTML);
                setTimeout(() => {
                    $(".alert").alert('close');
                }, 5000);
            }

            function getIconForAlert(type) {
                const icons = {
                    'success': 'check-circle',
                    'danger': 'exclamation-triangle',
                    'warning': 'exclamation-triangle',
                    'info': 'info-circle'
                };
                return icons[type] || 'info-circle';
            }

            // Cargar clientes desde el backend
            function loadClientes() {
                console.log("Cargando clientes...");
                $("#loadingState").show();
                $("#clientesTableBody").html(`
                    <tr>
                        <td colspan="6" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                        </td>
                    </tr>
                `);

                $.ajax({
                    url: "clienteservlet",
                    method: "GET",
                    dataType: "json",
                    timeout: 15000,
                    success: function (data) {
                        console.log("Clientes cargados:", data);
                        clientes = data || [];
                        clientesOriginal = [...clientes];
                        renderClientes(clientes);
                        $("#totalClientes").text(clientes.length);
                        $("#loadingState").hide();

                        if (clientes.length > 0) {
                            showAlert(`Se cargaron ${clientes.length} clientes correctamente`, 'success');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Error cargando clientes:", error);
                        $("#loadingState").hide();

                        let errorMessage = "Error al cargar clientes";
                        if (xhr.responseJSON && xhr.responseJSON.mensaje) {
                            errorMessage = xhr.responseJSON.mensaje;
                        } else if (status === 'timeout') {
                            errorMessage = "Tiempo de espera agotado. Verifique su conexión.";
                        }

                        showAlert(errorMessage, "danger");

                        // Mostrar mensaje en la tabla
                        $("#clientesTableBody").html(`
                            <tr>
                                <td colspan="6" class="text-center text-muted">
                                    <i class="bi bi-exclamation-triangle fs-1"></i><br>
                                    Error al cargar los datos
                                </td>
                            </tr>
                        `);
                    }
                });
            }

            // Renderizar tabla de clientes
            function renderClientes(lista) {
                let html = "";

                if (!lista || lista.length === 0) {
                    html = `
                        <tr>
                            <td colspan="6" class="text-center text-muted">
                                <i class="bi bi-inbox fs-1"></i><br>
                                No se encontraron clientes
                            </td>
                        </tr>`;
                } else {
                    lista.forEach(cliente => {
                        html += `
                            <tr>
                                <td class="text-center"><strong>${cliente.codiClie || ''}</strong></td>
                                <td class="text-center">
                                    <span class="badge bg-secondary">${cliente.ndniClie || 'Sin DNI'}</span>
                                </td>
                                <td>
                                    <strong>${cliente.nombClie || 'Sin nombre'}</strong>
                                </td>
                                <td class="text-center">
                                    ${cliente.celuClie ? `<i class="bi bi-phone"></i> ${cliente.celuClie}` : '<span class="text-muted">Sin celular</span>'}
                                </td>
                                <td>
                                    <small>${cliente.direClie || 'Sin dirección'}</small>
                                </td>
                                <td class="text-center">
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-sm btn-outline-primary" 
                                                onclick="editCliente(${cliente.codiClie})" 
                                                title="Editar cliente">
                                            <i class="bi bi-pencil"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger" 
                                                onclick="deleteCliente(${cliente.codiClie}, '${cliente.nombClie}')" 
                                                title="Eliminar cliente">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>`;
                    });
                }

                $("#clientesTableBody").html(html);
            }

            // Filtro de clientes
            function filterClientes() {
                const term = $("#searchInput").val().toLowerCase().trim();

                if (term === '') {
                    renderClientes(clientesOriginal);
                    $("#totalClientes").text(clientesOriginal.length);
                    return;
                }

                const filtered = clientesOriginal.filter(cliente => {
                    return (cliente.ndniClie && cliente.ndniClie.toLowerCase().includes(term)) ||
                           (cliente.nombClie && cliente.nombClie.toLowerCase().includes(term)) ||
                           (cliente.celuClie && cliente.celuClie.toLowerCase().includes(term)) ||
                           (cliente.direClie && cliente.direClie.toLowerCase().includes(term));
                });

                renderClientes(filtered);
                $("#totalClientes").text(filtered.length);
            }

            // Abrir modal para nuevo cliente
            function openNewClienteModal() {
                $("#clienteModalTitle").text("Nuevo Cliente");
                $("#formCliente")[0].reset();
                $("#clienteId").val("");
                currentClienteId = null;
                $("#btnSaveCliente").html('<i class="bi bi-save"></i> Crear Cliente');
                $("#clienteModal").modal('show');
            }

            // Editar cliente
            function editCliente(codiClie) {
                const cliente = clientes.find(c => c.codiClie === codiClie);

                if (!cliente) {
                    showAlert("Cliente no encontrado", 'danger');
                    return;
                }

                $("#clienteModalTitle").text("Editar Cliente");
                $("#clienteId").val(cliente.codiClie);
                $("#ndniClie").val(cliente.ndniClie || '');
                $("#nombClie").val(cliente.nombClie || '');
                $("#celuClie").val(cliente.celuClie || '');
                $("#direClie").val(cliente.direClie || '');

                currentClienteId = codiClie;
                $("#btnSaveCliente").html('<i class="bi bi-save"></i> Actualizar Cliente');
                $("#clienteModal").modal('show');
            }

            // Guardar cliente (crear o actualizar)
            function saveCliente() {
                // Validaciones del formulario
                const ndniClie = $("#ndniClie").val().trim();
                const nombClie = $("#nombClie").val().trim();
                const celuClie = $("#celuClie").val().trim();
                const direClie = $("#direClie").val().trim();

                if (!ndniClie || ndniClie.length !== 8) {
                    showAlert("El DNI debe tener exactamente 8 dígitos", 'danger');
                    $("#ndniClie").focus();
                    return;
                }

                if (!nombClie || nombClie.length < 2) {
                    showAlert("El nombre debe tener al menos 2 caracteres", 'danger');
                    $("#nombClie").focus();
                    return;
                }

                if (celuClie && celuClie.length !== 9) {
                    showAlert("El celular debe tener exactamente 9 dígitos o estar vacío", 'danger');
                    $("#celuClie").focus();
                    return;
                }

                const clienteData = {
                    ndniClie: ndniClie,
                    nombClie: nombClie,
                    celuClie: celuClie,
                    direClie: direClie
                };

                const isEdit = currentClienteId !== null;

                if (isEdit) {
                    clienteData.codiClie = currentClienteId;
                } else {
                    // Para crear, generar un ID temporal (el backend debería manejarlo)
                    clienteData.codiClie = Date.now();
                }

                // Deshabilitar botón mientras se procesa
                $("#btnSaveCliente").prop('disabled', true).html(
                    '<span class="spinner-border spinner-border-sm me-2"></span>Guardando...'
                );

                $.ajax({
                    url: "clienteservlet",
                    method: isEdit ? "PUT" : "POST",
                    contentType: "application/json",
                    data: JSON.stringify(clienteData),
                    dataType: "json",
                    success: function (response) {
                        console.log("Respuesta del servidor:", response);

                        if (response.success) {
                            showAlert(
                                isEdit ? "Cliente actualizado correctamente" : "Cliente creado correctamente", 
                                'success'
                            );
                            $("#clienteModal").modal('hide');
                            loadClientes(); // Recargar la lista
                        } else {
                            showAlert(response.mensaje || "Error al procesar la solicitud", 'danger');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Error guardando cliente:", error);

                        let errorMessage = "Error al guardar el cliente";
                        if (xhr.responseJSON && xhr.responseJSON.mensaje) {
                            errorMessage = xhr.responseJSON.mensaje;
                        } else if (xhr.status === 409) {
                            errorMessage = "Ya existe un cliente con ese DNI";
                        }

                        showAlert(errorMessage, 'danger');
                    },
                    complete: function () {
                        // Rehabilitar botón
                        $("#btnSaveCliente").prop('disabled', false).html(
                            '<i class="bi bi-save"></i> ' + (isEdit ? 'Actualizar Cliente' : 'Crear Cliente')
                        );
                    }
                });
            }

            // Confirmar eliminación de cliente
            function deleteCliente(codiClie, nombClie) {
                currentClienteId = codiClie;
                $("#deleteClienteInfo").html(`
                    <strong>ID:</strong> ${codiClie}<br>
                    <strong>Nombre:</strong> ${nombClie || 'Sin nombre'}
                `);
                $("#deleteModal").modal('show');
            }

            // Eliminar cliente confirmado
            function deleteClienteConfirmed(codiClie) {
                $("#confirmDeleteBtn").prop('disabled', true).html(
                    '<span class="spinner-border spinner-border-sm me-2"></span>Eliminando...'
                );

                $.ajax({
                    url: "clienteservlet?codiClie=" + codiClie,
                    method: "DELETE",
                    dataType: "json",
                    success: function (response) {
                        console.log("Respuesta eliminación:", response);

                        if (response.success) {
                            showAlert("Cliente eliminado correctamente", 'success');
                            $("#deleteModal").modal('hide');
                            loadClientes(); // Recargar la lista
                        } else {
                            showAlert(response.mensaje || "Error al eliminar el cliente", 'danger');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Error eliminando cliente:", error);

                        let errorMessage = "Error al eliminar el cliente";
                        if (xhr.responseJSON && xhr.responseJSON.mensaje) {
                            errorMessage = xhr.responseJSON.mensaje;
                        } else if (xhr.status === 404) {
                            errorMessage = "El cliente no fue encontrado";
                        }

                        showAlert(errorMessage, 'danger');
                    },
                    complete: function () {
                        $("#confirmDeleteBtn").prop('disabled', false).html(
                            '<i class="bi bi-trash"></i> Eliminar Cliente'
                        );
                        currentClienteId = null;
                    }
                });
            }
        </script>
    </body>
</html>
