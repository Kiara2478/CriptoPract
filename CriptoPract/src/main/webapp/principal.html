<!doctype html>
<html lang="es">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>AdminLTE v4 | Dashboard</title>

        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="title" content="AdminLTE v4 | Dashboard" />
        <meta name="author" content="ColorlibHQ" />
        <meta
            name="description"
            content="AdminLTE is a Free Bootstrap 5 Admin Dashboard, 30 example pages using Vanilla JS."
            />
        <meta
            name="keywords"
            content="bootstrap 5, bootstrap, bootstrap 5 admin dashboard, bootstrap 5 dashboard, bootstrap 5 charts, bootstrap 5 calendar, bootstrap 5 datepicker, bootstrap 5 tables, bootstrap 5 datatable, vanilla js datatable, colorlibhq, colorlibhq dashboard, colorlibhq admin dashboard"
            />

        <!-- Hojas de estilo -->
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/@fontsource/source-sans-3@5.0.12/index.css"
            integrity="sha256-tXJfXfp6Ewt1ilPzLDtQnJV4hclT9XuaZUKyUvmyr+Q="
            crossorigin="anonymous"
            />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/overlayscrollbars@2.10.1/styles/overlayscrollbars.min.css"
            integrity="sha256-tZHrRjVqNSRyWg2wbppGnT833E/Ys0DHWGwT04GiqQg="
            crossorigin="anonymous"
            />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
            integrity="sha256-9kPW/n5nn53j4WMRYAxe9c1rCY96Oogo/MKSVdKzPmI="
            crossorigin="anonymous"
            />

        <!-- CSS DE ADMIN LTE -->
        <link href="css/adminlte.css" rel="stylesheet" type="text/css"/>

        <!-- Scripts externos GOOGLE - MD5-->
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/apexcharts@3.37.1/dist/apexcharts.css"
            integrity="sha256-4MX+61mt9NVvvuPjUWdUdyfZfxSB1/Rf9WtqRHgG5S0="
            crossorigin="anonymous"
            />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/jsvectormap@1.5.3/dist/css/jsvectormap.min.css"
            integrity="sha256-+uGLJmmTKOqBr+2E6KDYs/NRsHxSkONXFHUL0fy2O/4="
            crossorigin="anonymous"
            />
        <!-- jQuery -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    </head>

    <body>
        <div class="app-wrapper">
            <!-- CABECERA PRINCIPAL -->
            <nav class="navbar navbar-expand-lg navbar-dark bg-dark shadow-sm">
                <div class="container-fluid">
                    <a class="navbar-brand" href="#">
                        <i class="bi bi-people-fill me-2"></i>Gestión de Personas
                    </a>

                    <!-- INFORMACIÓN DE USUARIO -->
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">
                                <i class="bi bi-person-circle me-1"></i>
                                <span id="userName">Usuario</span>
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li class="dropdown-header">
                                    <strong id="nombRol">Rol</strong><br>
                                    <small class="text-muted" id="nombEmpr">Empresa</small>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#cambiarClaveModal">
                                        <i class="bi bi-key me-2"></i>Cambiar Contraseña
                                    </a></li>
                                <li><a class="dropdown-item" href="#" id="logoutBtn">
                                        <i class="bi bi-box-arrow-right me-2"></i>Cerrar Sesión
                                    </a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- BARRA LATERAL -->
            <aside class="app-sidebar bg-body-secondary shadow" data-bs-theme="dark">
                <div class="sidebar-brand">    
                    <!--LOGO LATERAL-->
                    <a href="principal.html" class="brand-link">
                        <img
                            src="assets/img/AdminLTELogo.png"
                            alt="AdminLTE Logo"
                            class="brand-image opacity-75 shadow"
                            />

                        <span class="brand-text fw-light">AdminLTE 4</span>
                    </a>
                </div>

                <div class="sidebar-wrapper">
                    <nav class="mt-2">
                        <!-- DASHBOARD-->
                        <ul
                            class="nav sidebar-menu flex-column"
                            data-lte-toggle="treeview"
                            role="menu"
                            data-accordion="false"
                            >
                            <li class="nav-item menu-open">
                                <a href="#" class="nav-link active">
                                    <i class="nav-icon bi bi-speedometer"></i>
                                    <p>
                                        Dashboard
                                        <i class="nav-arrow bi bi-chevron-right"></i>
                                    </p>
                                </a>
                                <ul class="nav nav-treeview">
                                    <li class="nav-item">
                                        <a href="persona.html" class="nav-link active">
                                            <i class="nav-icon bi bi-circle"></i>
                                            <p>Listar personas</p>
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a href="persona.html" class="nav-link">
                                            <i class="nav-icon bi bi-circle"></i>
                                            <p>Crud personas</p>
                                        </a>
                                    </li>
                                    <li class="nav-item">
                                        <a href="cliente.html" class="nav-link">
                                            <i class="nav-icon bi bi-circle"></i>
                                            <p>Crud clientes</p>
                                        </a>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                    </nav>
                </div>
            </aside>

            <!-- CONTENIDO PRINCIPAL -->
            <main class="container-fluid p-4">
                <div class="card shadow">
                    <!-- CABECERA DE LA TARJETA -->
                    <div class="card-header d-flex justify-content-between align-items-center text-black">
                        <h3 class="mb-0"><i class="bi bi-people me-2"></i>Gestión de Personas</h3>
                        <div>
                            <button class="btn btn-success text-light btn-sm" onclick="loadPersonas()">
                                <i class="bi bi-arrow-clockwise"></i> Actualizar
                            </button>
                            <span class="badge bg-warning text-dark ms-2" id="totalPersonas">0</span>
                        </div>
                    </div>

                    <div class="card-body">
                        <!-- ALERTAS -->
                        <div id="alertContainer"></div>

                        <!-- BUSCADOR -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" class="form-control" id="searchInput" 
                                           placeholder="Buscar por nombre, DNI o usuario..." 
                                           onkeyup="filterPersonas()">
                                </div>
                            </div>
                        </div>
<!-- Boton de reporte-->
                                        <div class="mb-2">
                                            <a href="/colegio/reportePDF" target="_blank" class="btn btn-success">
                                                📄 Generar Reporte
                                            </a>
                                        </div>
                        <!-- TABLA DE PERSONAS -->
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark text-center">
                                    <tr>
                                        <th>ID</th>
                                        <th>DNI</th>
                                        <th>Nombres</th>
                                        <th>Fecha Nacimiento</th>
                                        <th>Edad</th>
                                        <th>Peso (kg)</th>
                                        <th>Usuario</th>
                                        <th>Contraseña</th>

                                    </tr>
                                </thead>
                                <tbody id="personasTableBody">
                                    <tr>
                                                                                    <td colspan="8" class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Cargando...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>

            <!--PIE DE PAGINA -->
            <footer class="app-footer">
                <!--MENSAJE DERECHA-->
                <div class="float-end d-none d-sm-inline">Anything you want</div>

                <strong>
                    Copyright &copy; 2022-2025&nbsp;
                    <a href="https://adminlte.io" class="text-decoration-none">AdminLTE.io</a>.
                </strong>
                All rights reserved.
            </footer>
        </div>

        <!-- MODAL PARA CAMBIAR CONTRASEÑA -->
        <div class="modal fade" id="cambiarClaveModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-warning">
                        <h5 class="modal-title">Cambiar Contraseña</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="formCambiarClave">
                            <div class="mb-3">
                                <label for="logiUsua" class="form-label">Usuario *</label>
                                <input type="text" class="form-control" id="logiUsua" required readonly>
                            </div>
                            <div class="mb-3">
                                <label for="passUsua" class="form-label">Contraseña Actual *</label>
                                <input type="password" class="form-control" id="passUsua" required>
                            </div>
                            <div class="mb-3">
                                <label for="newpass" class="form-label">Nueva Contraseña *</label>
                                <input type="password" class="form-control" id="newpass" required minlength="4">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" form="formCambiarClave" class="btn btn-warning">
                            <i class="bi bi-key"></i> Cambiar Contraseña
                        </button>
                    </div>
                </div>
            </div>
        </div>



        <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

        <!-- SCRIPTS -->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

        <script>
            // Variables globales
            let personas = [];
            let personasOriginal = [];
            let currentUserLogin = '';

            // Inicialización al cargar la página
            $(document).ready(function () {
                verificarSesion();
                loadPersonas();
                configurarEventos();
            });

            // Verificar sesión activa - compatible con tu sistema de login
            function verificarSesion() {
                $.ajax({
                    url: "sessioninfoservlet",
                    type: "GET",
                    dataType: "json",
                    timeout: 10000, // 10 segundos de timeout
                    success: function (data) {
                        console.log("Datos de sesión:", data);
                        if (data.error || !data.usuarioId) {
                            console.log("No hay sesión activa, redirigiendo...");
                            window.location.href = "index.html";
                        } else {
                            // Usar los datos de tu sesión
                            $("#userName").text(data.usuarioNombre || data.nombUsua || "Usuario");
                            currentUserLogin = data.usuarioLogin; // Guardar el login del usuario actual
                            
                            // Si tienes estos campos en sessioninfoservlet, úsalos; sino, oculta
                            if (data.nombRol)
                                $("#nombRol").text(data.nombRol);
                            if (data.nombEmpr)
                                $("#nombEmpr").text(data.nombEmpr);

                            console.log("Sesión válida para usuario:", data.usuarioNombre);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.log("Error en verificación de sesión:", error);
                        // Solo redirigir si es un error 401/403 o timeout
                        if (xhr.status === 401 || xhr.status === 403 || status === 'timeout') {
                            window.location.href = "index.html";
                        }
                    }
                });
            }

            // Configurar eventos
            function configurarEventos() {
                // Logout
                $("#logoutBtn").click(function (e) {
                    e.preventDefault();
                    if (confirm("¿Está seguro que desea cerrar sesión?")) {
                        $.ajax({
                            url: "logout",
                            type: "POST",
                            dataType: "json",
                            success: function (response) {
                                console.log("Logout response:", response);
                                // Redirigir independientemente de la respuesta
                                window.location.href = "index.html";
                            },
                            error: function (xhr, status, error) {
                                console.log("Error en logout:", error);
                                // Redirigir incluso si hay error
                                window.location.href = "index.html";
                            }
                        });
                    }
                });

                // Pre-llenar usuario al abrir modal de cambiar contraseña
                $('#cambiarClaveModal').on('show.bs.modal', function () {
                    $('#logiUsua').val(currentUserLogin);
                });

                // Cambiar contraseña
                $("#formCambiarClave").submit(function (e) {
                    e.preventDefault();
                    let logiUsua = $("#logiUsua").val();
                    let passUsua = $("#passUsua").val();
                    let newpass = $("#newpass").val();

                    // Validaciones básicas
                    if (!logiUsua || !passUsua || !newpass) {
                        showAlert("Todos los campos son obligatorios", 'danger');
                        return;
                    }

                    if (newpass.length < 4) {
                        showAlert("La nueva contraseña debe tener al menos 4 caracteres", 'danger');
                        return;
                    }

                    $.ajax({
                        type: "POST",
                        url: "cambiarcontrasena",
                        data: {
                            logiUsua: logiUsua,
                            passUsua: passUsua,
                            newpass: newpass
                        },
                        dataType: "json",
                        success: function (response) {
                            console.log("Cambiar contraseña response:", response);
                            if (response.resultado === "ok") {
                                showAlert(response.mensaje, 'success');
                                $("#cambiarClaveModal").modal('hide');
                                $("#formCambiarClave")[0].reset();
                                setTimeout(() => window.location.href = "index.html", 2000);
                            } else {
                                showAlert(response.mensaje, 'danger');
                            }
                        },
                        error: function (xhr, status, error) {
                            console.error("Error al cambiar contraseña:", error);
                            showAlert("Error al comunicarse con el servidor.", 'danger');
                        }
                    });
                });


            }

            // Cargar todas las personas
            function loadPersonas() {
                $.ajax({
                    url: "persona",
                    type: "GET",
                    dataType: "json",
                    success: function (response) {
                        if (response.data) {
                            personas = response.data;
                            personasOriginal = [...personas];
                            renderPersonasTable();
                            $("#totalPersonas").text(personas.length);
                        }
                    },
                    error: function (xhr, status, error) {
                        showAlert("Error al cargar personas: " + error, 'danger');
                    }
                });
            }

            // Renderizar tabla de personas
            function renderPersonasTable() {
                const tbody = $("#personasTableBody");
                tbody.empty();

                if (personas.length === 0) {
                    tbody.append(`
                        <tr>
                            <td colspan="8" class="text-center text-muted">
                                <i class="bi bi-inbox"></i> No hay personas registradas
                            </td>
                        </tr>
                    `);
                    return;
                }

                personas.forEach(persona => {
                    const edad = calcularEdad(persona.fechaNaciPers);
                    const peso = persona.pesoPers ? persona.pesoPers + ' kg' : 'N/A';
                    
                    tbody.append(`
                        <tr>
                            <td class="text-center">${persona.codiPers}</td>
                            <td>${persona.ndniPers}</td>
                            <td>${persona.nombPers}</td>
                            <td class="text-center">${formatearFecha(persona.fechaNaciPers)}</td>
                            <td class="text-center">${edad} años</td>
                            <td class="text-center">${peso}</td>
                            <td>${persona.logiPers}</td>
                            <td>
                                <span class="badge bg-secondary">
                                    <i class="bi bi-shield-lock"></i> MD5 Hash
                                </span>
                                <br>
                                <small class="text-muted font-monospace">${persona.passPers ? persona.passPers.substring(0, 12) + '...' : 'N/A'}</small>
                            </td>
                        </tr>
                    `);
                });
            }



            // Filtrar personas en tiempo real
            function filterPersonas() {
                const searchTerm = $("#searchInput").val().toLowerCase();

                if (searchTerm === '') {
                    personas = [...personasOriginal];
                } else {
                    personas = personasOriginal.filter(persona =>
                        persona.nombPers.toLowerCase().includes(searchTerm) ||
                        persona.ndniPers.includes(searchTerm) ||
                        persona.logiPers.toLowerCase().includes(searchTerm)
                    );
                }

                renderPersonasTable();
                $("#totalPersonas").text(personas.length);
            }

            // Calcular edad
            function calcularEdad(fechaNacimiento) {
                if (!fechaNacimiento) return 'N/A';
                
                const hoy = new Date();
                const nacimiento = new Date(fechaNacimiento);
                let edad = hoy.getFullYear() - nacimiento.getFullYear();
                const mes = hoy.getMonth() - nacimiento.getMonth();

                if (mes < 0 || (mes === 0 && hoy.getDate() < nacimiento.getDate())) {
                    edad--;
                }

                return edad;
            }

            // Formatear fecha
            function formatearFecha(fecha) {
                if (!fecha) return 'N/A';
                
                const date = new Date(fecha);
                return date.toLocaleDateString('es-ES');
            }

            // Mostrar alertas
            function showAlert(message, type) {
                const alertHtml = `
                    <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                        <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : 'info-circle'}"></i>
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                    `;

                $("#alertContainer").html(alertHtml);

                // Auto-ocultar después de 5 segundos
                setTimeout(() => {
                    $(".alert").alert('close');
                }, 5000);
            }
        </script>
    </body>
</html>